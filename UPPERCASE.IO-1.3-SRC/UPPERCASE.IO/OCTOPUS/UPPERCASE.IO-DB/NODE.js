global.CONNECT_TO_DB_SERVER=CONNECT_TO_DB_SERVER=METHOD(function(o){var t,i;return o.getNativeDB=i=function(){return t},{run:function(o,i){"use strict";var n=o.username,e=o.password,r=void 0===o.host?"127.0.0.1":o.host,d=void 0===o.port?27017:o.port,E=o.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==n&&void 0!==e?n+":"+e+"@":"")+r+":"+d+"/"+E,function(o,n){o!==TO_DELETE?console.log("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED:",o):(t=n,i())})}}}),FOR_BOX(function(o){"use strict";o.DB=CLASS({init:function(t,i,n){var e,r,d,E,a,c,_,v,u=require("mongodb").ObjectID,f=CONNECT_TO_DB_SERVER.getNativeDB(),s=f.collection(o.boxName+"."+n),D=f.collection(o.boxName+"."+n+"__BACKUP"),m=f.collection(o.boxName+"."+n+"__ERROR"),O=function(o){return new u(o)},T=function(o){return void 0!==o._id&&(o.id=o._id.toString()),delete o._id,delete o.__IS_ENABLED,delete o.__RANDOM_KEY,o},g=function(o){EACH(o,function(t,i){t===TO_DELETE?REMOVE({data:o,key:i}):(CHECK_IS_DATA(t)===!0||CHECK_IS_ARRAY(t)===!0)&&g(t)})},A=function(o){var t=function(o){void 0!==o.id&&(CHECK_IS_DATA(o.id)===!0?(EACH(o.id,function(t,i){CHECK_IS_DATA(t)===!0||CHECK_IS_ARRAY(t)===!0?EACH(t,function(o,i){t[i]=O(o)}):o.id[i]=O(t)}),o._id=o.id):o._id=O(id),delete o.id),o.__IS_ENABLED=!0,EACH(o,function(t,i){void 0===t&&delete o[i]})};void 0!==o.$and?EACH(o.$and,function(o){t(o)}):void 0!==o.$or?EACH(o.$or,function(o){t(o)}):t(o)},C=function(t){var i=t.method,e=t.data,r=new Date,d={method:i,time:r,data:e};D.save(d,function(){}),NODE_CONFIG.isDBLogMode===!0&&console.log("[UPPERCASE.IO-DB] `"+o.boxName+"."+n+"` DATA SAVED:",d)},N=function(t){t.time=new Date,m.save(t,function(){}),console.log("[UPPERCASE.IO-DB] `"+o.boxName+"."+n+"` ERROR:",t)};i.create=e=function(o,t){var i;try{o.__IS_ENABLED=!0,o.__RANDOM_KEY=Math.random(),o.createTime=new Date,g(o),s.save(o,function(n,e){n===TO_DELETE?(C({method:"create",data:e}),T(e),void 0!==t&&t(void 0,e)):(i=n.toString(),N({method:"create",data:o,errorMsg:i}),void 0!==t&&t(i))})}catch(n){i=n.toString(),N({method:"create",data:o,errorMsg:i}),void 0!==t&&t(i)}},r=function(o,t){var i,n=o.filter,e=o.sort;try{A(n),s.find(n).sort(e).limit(1).toArray(function(n,e){var r;n===TO_DELETE?(e!==TO_DELETE&&e.length>0&&(r=e[0],T(r)),t(void 0,r)):(i=n.toString(),N({method:"get",params:o,errorMsg:i}),t(i))})}catch(r){i=r.toString(),N({method:"get",params:o,errorMsg:i}),t(i)}},i.get=d=function(o,t){var i,n,e,d;void 0!==o&&void 0===t&&(t=o,o=void 0),CHECK_IS_DATA(o)===!0?(i=o.filter,n=o.sort,e=o.isRandom):i=void 0!==o?{_id:O(o)}:{},void 0===i&&(i={}),void 0===n&&(n={createTime:-1}),e===!0?(i.__RANDOM_KEY={$gte:d=Math.random()},n.__RANDOM_KEY=1,r({filter:i,sort:n},function(o,e){void 0===o&&void 0===e?(i.__RANDOM_KEY={$lte:d},r({filter:i,sort:n},t)):t(o,e)})):r({filter:i,sort:n},t)},i.update=E=function(o,t){var i,n,e=o.id,r=o.$inc;try{i={_id:O(e),__IS_ENABLED:!0},NEXT([function(o){s.findOne(i,o)},function(i){return function(e,d){e===TO_DELETE?d===TO_DELETE?void 0!==t&&t():(EACH(o,function(o,t){"id"!==t&&"_id"!==t&&"__IS_ENABLED"!==t&&"createTime"!==t&&"$inc"!==t&&(d[t]=o)}),g(d),d.lastUpdateTime=new Date,void 0!==r?s.save(d,function(o){i(d,o)}):s.save(d,function(o){i.next(d,o)})):(n=e.toString(),N({method:"update",data:o,errorMsg:n}),void 0!==t&&t(n))}},function(o){return function(t){s.update(i,{$inc:r},function(i){EACH(r,function(o,i){t[i]+=o}),o(t,i)})}},function(){return function(i,e){e===TO_DELETE?(C({method:"update",data:i}),T(i),void 0!==t&&t(void 0,i)):(n=e.toString(),N({method:"update",data:o,errorMsg:n}),void 0!==t&&t(n))}}])}catch(d){n=d.toString(),N({method:"update",data:o,errorMsg:n}),void 0!==t&&t(n)}},i.remove=a=function(o,t){var i,n;try{i={_id:O(o),__IS_ENABLED:!0},s.findOne(i,function(i,e){i===TO_DELETE?e===TO_DELETE?void 0!==t&&t():(e.__IS_ENABLED=!1,e.removeTime=new Date,s.save(e,function(i){i===TO_DELETE?(C({method:"remove",data:e}),T(e),void 0!==t&&t(void 0,e)):(n=i.toString(),N({method:"remove",id:o,errorMsg:n}),void 0!==t&&t(n))})):(n=i.toString(),N({method:"remove",id:o,errorMsg:n}),void 0!==t&&t(n))})}catch(e){n=e.toString(),N({method:"remove",id:o,errorMsg:n}),void 0!==t&&t(n)}},i.find=c=function(o,t){var i,n,e=void 0===o?void 0:o.filter,r=void 0===o?void 0:o.sort,d=void 0===o?void 0:o.start,E=void 0===o||void 0===o.count?void 0:INTEGER(o.count),a=void 0===o||void 0===o.isFindAll?void 0:INTEGER(o.isFindAll);void 0!==o&&void 0===t&&(t=o);try{void 0===e&&(e={}),void 0===r&&(r={createTime:-1}),void 0===d&&(d=0),a!==!0&&(void 0===E||E>NODE_CONFIG.maxDataCount||isNaN(E)===!0?E=NODE_CONFIG.maxDataCount:1>E&&(E=1)),A(e),n=function(n,e){n===TO_DELETE?(e!==TO_DELETE&&EACH(e,function(o){T(o)}),t(void 0,e)):(i=n.toString(),N({method:"find",params:o,errorMsg:i}),t(i))},a===!0?s.find(e).sort(r).skip(d).toArray(n):s.find(e).sort(r).skip(d).limit(E).toArray(n)}catch(c){i=c.toString(),N({method:"find",params:o,errorMsg:i}),t(i)}},i.count=_=function(o,t){var i;void 0!==o&&void 0===t&&(t=o),void 0===o&&(o={});try{A(o),s.find(o).count(function(n,e){n===TO_DELETE?t(void 0,e):(i=n.toString(),N({method:"count",filter:o,errorMsg:i}),t(i))})}catch(n){i=n.toString(),N({method:"count",filter:o,errorMsg:i}),t(i)}},i.checkIsExists=v=function(o,t){var i;void 0!==o&&void 0===t&&(t=o),void 0===o?o={}:CHECK_IS_DATA(o)!==!0&&(o={_id:O(o)});try{A(o),s.find(o).count(function(n,e){n===TO_DELETE?t(void 0,void 0!==e&&e>0):(i=n.toString(),N({method:"checkIsExists",filter:o,errorMsg:i}),t(i))})}catch(n){i=n.toString(),N({method:"checkIsExists",filter:o,errorMsg:i}),t(i)}}}})}),FOR_BOX(function(o){"use strict";o.LOG_DB=CLASS({init:function(t,i,n){var e,r=CONNECT_TO_DB_SERVER.getNativeDB(),d=r.collection(o.boxName+"."+n);i.log=e=function(o){o.time=new Date,d.save(o,function(){})}}})}),OVERRIDE(NODE_CONFIG,function(o){global.NODE_CONFIG=NODE_CONFIG=COMBINE_DATA({origin:o,extend:{isDBLogMode:!1,maxDataCount:1e3}})});