global.CONNS=CONNS=OBJECT({init:function(e,o){"use strict";var t,r,a,n=o.socketPack,i={};o.addRoomFunc=t=function(e,o){void 0===i[e]&&(i[e]=[]),i[e].push(o)},n.on("connection",function(e){var o,t=e.handshake.headers["x-forwarded-for"],r={},a={},n={},d={};void 0===t&&(t=e.handshake.address.address),e.addListener("disconnect",function(){EACH(d,function(e){EACH(e,function(e){e()})})}),e.addListener("__ENTER_ROOM",function(c){EACH(i,function(i,s){var u,v="",f=s,m={};return u=function(e){var o,t;return-1!==f.indexOf("{")&&-1!==f.indexOf("}")&&(t=f.substring(0,f.indexOf("{")),v+"/"===t)?(o=f.substring(f.indexOf("{")+1,f.indexOf("}")),f=t+e+f.substring(f.indexOf("}")+1),{name:o,value:e}):void 0},EACH(c.split("/"),function(e,o){var t=u(e);return void 0!==t&&(m[t.name]=t.value),0===o?v=e:v+="/"+e,v===f?!1:void 0}),c===f?(void 0===a[c]?(r[c]=[],d[c]=[],e.join(c),EACH(i,function(a){r[c].push(a(c,e,t,e.handshake.headers,m,function(e){o=e},function(){return o},function(){o=void 0},n,d[c]))}),a[c]=1):a[c]+=1,!1):void 0})}),e.addListener("__EXIT_ROOM",function(o){a[o]-=1,0===a[o]&&(EACH(r[o],function(e){e.removeAllListeners()}),e.leave(o),delete r[o],delete a[o],delete d[o])})}),o.emitToAllSockets=r=function(e){var o=e.ns,t=e.listenerName,r=e.data;CONNS.socketPack["in"](o).emit(t,r)},o.emitToAllWorkers=a=function(e){r(e),o.broadcastToAllWorkers({methodName:"emitToAllSockets",data:e})}}}),FOR_BOX(function(e){"use strict";OVERRIDE(e.MODEL,function(){e.MODEL=CLASS({init:function(o,t,r){var a,n,i,d,c,s,u,v,f,m,E,O,h,R,C,A,l,N,b,p,M,D,S=r.name,g=r.config,_=e.DB(S);void 0!==g&&(a=g.create,n=g.get,i=g.update,d=g.remove,c=g.find,s=g.count,u=g.checkIsExists,void 0!==a&&(v=a.valid,m=a.initData),void 0!==i&&(f=i.valid)),o.getCreateValid=O=function(){return v},o.getUpdateValid=h=function(){return f},o.initData=E=function(e){return void 0!==m&&m(e),e},e.ROOM(S+"/create"),e.ROOM(S+"/remove"),e.ROOM(S+"/{propertyName}/{value}/create"),e.ROOM(S+"/{propertyName}/{value}/remove"),e.ROOM(S,function(t){a!==!1&&t.on("create",function(r,a){var n,i;E(r),void 0!==v&&(n=v.check({data:r})),void 0!==n&&n.checkHasError()===!0?a({hasError:!0,errors:n.getErrors()}):(i=function(){_.create(r,function(r,n){void 0!==r?a({hasError:!0,errorMsg:r}):(void 0!==o.afterCreate&&o.afterCreate(n),void 0!==o.afterCreateRoom&&o.afterCreateRoom({savedData:n,room:t}),e.ROOMS(S+"/create").broadcast({methodName:"create",data:n}),EACH(n,function(o,t){e.ROOMS(S+"/"+t+"/"+o+"/create").broadcast({methodName:"create",data:n})}),a({hasError:!1,savedData:n}))})},void 0===o.beforeCreateRoom?void 0!==o.beforeCreate?o.beforeCreate(r,{ret:a,proc:i})!==!1&&i():i():o.beforeCreateRoom({data:r,room:t},{ret:a,proc:i}))}),n!==!1&&t.on("get",A),c!==!1&&t.on("find",function(e,o){delete e.isFindAll,b(e,o)}),s!==!1&&t.on("count",p),u!==!1&&t.on("checkIsExists",M)}),e.ROOM(S+"/{id}",function(t,r){var a=r.id;i!==!1&&t.on("update",function(r,n){var i,d=void 0===f?void 0:f.check({data:r,isExceptUndefined:!0});r.id=a,void 0!==d&&d.checkHasError()===!0?n({hasError:!0,errors:d.getErrors()}):(i=function(){_.update(r,function(r,a){void 0!==r?n({hasError:!0,errorMsg:r}):(void 0!==a&&(void 0!==o.afterUpdate&&o.afterUpdate(a),void 0!==o.afterUpdateRoom&&o.afterUpdateRoom({savedData:a,room:t}),t.broadcast({methodName:"update",data:a}),EACH(a,function(o,t){e.ROOMS(S+"/"+t+"/"+o+"/update").broadcast({methodName:"update",data:a})})),n({hasError:!1,savedData:a}))})},void 0===o.beforeUpdateRoom?void 0!==o.beforeUpdate?o.beforeUpdate(r,{ret:n,proc:i})!==!1&&i():i():o.beforeUpdateRoom({data:r,room:t},{ret:n,proc:i})!==!1&&i())}),d!==!1&&t.on("remove",function(r,a){var n;n=function(){_.remove(r,function(r,n){void 0!==r?a({hasError:!0,errorMsg:r}):(void 0!==n&&(void 0!==o.afterRemove&&o.afterRemove(n),void 0!==o.afterRemoveRoom&&o.afterRemoveRoom({savedData:n,room:t}),t.broadcast({methodName:"remove",data:n}),EACH(n,function(o,t){e.ROOMS(S+"/"+t+"/"+o+"/remove").broadcast({methodName:"remove",data:n})})),a({hasError:!1,savedData:n}))})},void 0===o.beforeRemoveRoom?void 0!==o.beforeRemove?o.beforeRemove(r,{ret:a,proc:n})!==!1&&n():n():o.beforeRemoveRoom({id:r,room:t},{ret:a,proc:n})!==!1&&n()})}),o.getDB=R=function(){return _},a!==!1&&(t.create=C=function(t,r){var a,n;E(t),void 0!==v&&(a=v.check({data:t})),void 0!==a&&a.checkHasError()===!0?void 0!==r&&r({hasError:!0,errors:a.getErrors()}):(n=function(){_.create(t,function(t,a){void 0!==t?void 0!==r&&r({hasError:!0,errorMsg:t}):(void 0!==o.afterCreate&&o.afterCreate(a),e.ROOMS(S+"/create").broadcast({methodName:"create",data:a}),EACH(a,function(o,t){e.ROOMS(S+"/"+t+"/"+o+"/create").broadcast({methodName:"create",data:a})}),void 0!==r&&r({hasError:!1,savedData:a}))})},void 0!==o.beforeCreate?o.beforeCreate(t,{ret:r,proc:n})!==!1&&n():n())}),n!==!1&&(t.get=A=function(e,t){_.get(e,function(e,r){void 0!==e?void 0!==t&&t({hasError:!0,errorMsg:e}):(void 0===o.get||o.get(r,t)!==!1)&&void 0!==t&&t({hasError:!1,savedData:r})})}),i!==!1&&(t.update=l=function(t,r){var a,n=void 0===f?void 0:f.check({data:t,isExceptUndefined:!0});void 0!==n&&n.checkHasError()===!0?void 0!==r&&r({hasError:!0,errors:n.getErrors()}):(a=function(){_.update(t,function(a,n){void 0!==a?void 0!==r&&r({hasError:!0,errorMsg:a}):(void 0!==n&&(void 0!==o.afterUpdate&&o.afterUpdate(n),e.ROOMS(S+"/"+t.id).broadcast({methodName:"update",data:n}),EACH(n,function(o,t){e.ROOMS(S+"/"+t+"/"+o+"/update").broadcast({methodName:"update",data:n})})),void 0!==r&&r({hasError:!1,savedData:n}))})},void 0!==o.beforeUpdate?o.beforeUpdate(t,{ret:r,proc:a})!==!1&&a():a())}),d!==!1&&(t.remove=N=function(t,r){var a;a=function(){_.remove(t,function(t,a){void 0!==t?void 0!==r&&r({hasError:!0,errorMsg:t}):(void 0!==a&&(void 0!==o.afterRemove&&o.afterRemove(a),e.ROOMS(S+"/"+a.id).broadcast({methodName:"remove",data:a}),ACH(a,function(o,t){e.ROOMS(S+"/"+t+"/"+o+"/remove").broadcast({methodName:"remove",data:a})})),void 0!==r&&r({hasError:!1,savedData:a}))})},void 0!==o.beforeRemove?o.beforeRemove(t,{ret:r,proc:a})!==!1&&a():a()}),c!==!1&&(t.find=b=function(e,t){void 0!==e&&void 0===t&&(t=e,e=void 0),_.find(e,function(e,r){void 0!==e?void 0!==t&&t({hasError:!0,errorMsg:e}):(void 0===o.find||o.find(r,t)!==!1)&&void 0!==t&&t({hasError:!1,savedDataSet:r})})}),s!==!1&&(t.count=p=function(e,t){void 0!==e&&void 0===t&&(t=e,e=void 0),_.count(e,function(e,r){void 0!==e?void 0!==t&&t({hasError:!0,errorMsg:e}):(void 0===o.count||o.count(r,t)!==!1)&&void 0!==t&&t({hasError:!1,count:r})})}),u!==!1&&(t.checkIsExists=M=function(e,t){void 0!==e&&void 0===t&&(t=e,e=void 0),_.checkIsExists(e,function(e,r){void 0!==e?void 0!==t&&t({hasError:!0,errorMsg:e}):(void 0===o.checkIsExists||o.checkIsExists(r,t)!==!1)&&void 0!==t&&t({hasError:!1,isExists:r})})}),o.getName=D=function(){return S}}})})}),FOR_BOX(function(e){"use strict";e.MODULE=METHOD({run:function(o){var t=__dirname+"/../..";return require(t+"/"+e.boxName+"/SERVER/node_modules/"+o)}})}),OVERRIDE(NODE_CONFIG,function(e){global.NODE_CONFIG=NODE_CONFIG=COMBINE_DATA({origin:e,extend:{dbName:"UPPERCASE_IO-testdb",dbUsername:"test",dbPassword:"test",isNotRequiringDBAuth:!1,maxDataCount:1e3,securedUsername:"test",securedPassword:"test"}})}),FOR_BOX(function(e){"use strict";e.ROOM=METHOD({run:function(o,t){CONNS.addRoomFunc(e.boxName+"/"+o,function(e,o,r,a,n,i,d,c,s,u){var v=OBJECT({init:function(t,n){var v,f,m,E,O,h,R,C,A,l,N,b,p,M,D={};n.on=v=function(t,r){var a,n=e+"/"+t;a=function(e){var t=CHECK_IS_DATA(e.data)===!0?UNPACK_DATA(e.data):e.data,a=e.instantListenerName;r(t,function(e){o.emit(a,CHECK_IS_DATA(e)===!0?PACK_DATA(e):e)})},o.addListener(n,a),void 0===D[n]&&(D[n]=[]),D[n].push(a)},n.broadcast=f=function(o){var t=o.methodName,r=CHECK_IS_DATA(o.data)===!0?PACK_DATA(o.data):o.data,a=e+"/"+t;CONNS.emitToAllWorkers({fullURI:e,listenerName:a,data:r})},n.broadcastExceptSender=m=function(t){var r=t.methodName,a=CHECK_IS_DATA(t.data)===!0?PACK_DATA(t.data):t.data,n=e+"/"+r;o.broadcast.to(e).emit(n,a),CONNS.type.broadcastToAllWorkers({methodName:"emitToAllSockets",data:{fullURI:e,listenerName:n,data:a}})},n.removeAllListeners=E=function(){EACH(D,function(e,t){EACH(e,function(e){o.removeListener(t,e)})}),D.length=0},n.setAuthKey=O=function(e){i(e)},n.getAuthKey=h=function(){return d()},n.removeAuthKey=R=function(){c()},n.addRole=C=function(e){s[e]=!0},n.checkRole=A=function(e){return s[e]===!0},n.removeRole=l=function(e){REMOVE({data:s,key:e})},n.removeAllRoles=N=function(){EACH(s,function(e,o){REMOVE({data:s,key:o})})},n.addDisconnectListener=b=function(e){u.push(e)},n.getIp=p=function(){return r},n.getHeaders=M=function(){return a}}});return void 0!==t&&t(v,n),v})}})}),FOR_BOX(function(e){"use strict";e.ROOMS=CLASS({init:function(o,t,r){var a,n=e.boxName+"/"+r;t.broadcast=a=function(e){var o=e.methodName,t=CHECK_IS_DATA(e.data)===!0?PACK_DATA(e.data):e.data,r=n+"/"+o;CONNS.socketPack["in"](n).emit(r,t)}}})}),global.TIME_SYNC=TIME_SYNC=OBJECT({init:function(){"use strict";UPPERCASE.IO.ROOM("timeSync",function(e){e.on("sync",function(e,o){var t=new Date,r=e.now;o({diff:r-t})})})}});